# specs -----------
state_name <- pop %>% dplyr::filter(abbrev == state) %>% pull(place)
max_date   <- as.Date(today - 1)
min_date   <- as.Date(max_date - (days_of_data - 1))
obs_days   <- length(as.Date(min_date):as.Date(max_date))
t_pred     <- 150 # number of predicted days
N          <- pop %>% filter(abbrev == state) %>% pull(population)
plt        <- FALSE
save_plt   <- FALSE
# load and prepare ----------
data <- readr::read_csv("https://api.covid19india.org/csv/latest/state_wise_daily.csv",
col_types = cols()) %>%
janitor::clean_names() %>%
dplyr::select("date" = "date_ymd", "status", "val" = tolower(state)) %>%
arrange(date) %>%
tidyr::pivot_wider(
names_from  = "status",
values_from = "val",
id_cols = "date"
) %>%
dplyr::filter(date <= max_date)
data_initial <- get_init(data)
data         <- data %>% dplyr::filter(date >= min_date)
mCFR         <- tail(cumsum(data$Deceased) / cumsum(data$Deceased + data$Recovered), 1)
phases       <- get_phase(start_date = min_date, end_date = max_date)
phases
# predict -----------
result    <- SEIRfansy::SEIRfansy.predict(
data            = abs(data %>% dplyr::select(-date)),
init_pars       = NULL,
data_init       = data_initial,
T_predict       = t_pred,
niter           = n_iter,
BurnIn          = burn_in,
model           = "Multinomial",
N               = N,
lambda          = 1/(69.416 * 365),
mu              = 1/(69.416 * 365),
period_start    = phases,
opt_num         = opt_num,
auto.initialize = T,
alpha_u         = 0.5,
f               = 0.15,
plot            = plt,
save_plots      = save_plt
)
warnings()
# predict -----------
result    <- SEIRfansy::SEIRfansy.predict(
data            = abs(data %>% dplyr::select(-date)),
init_pars       = NULL,
data_init       = data_initial,
T_predict       = t_pred,
niter           = n_iter,
BurnIn          = burn_in,
model           = "Multinomial",
N               = N,
lambda          = 1/(69.416 * 365),
mu              = 1/(69.416 * 365),
period_start    = phases,
opt_num         = opt_num,
auto.initialize = T,
alpha_u         = 0.5,
f               = 0.15,
plot            = plt,
save_plots      = save_plt
)
# predict -----------
result    <- SEIRfansy::SEIRfansy.predict(
data            = abs(data %>% dplyr::select(-date)),
init_pars       = NULL,
data_init       = data_initial,
T_predict       = t_pred,
niter           = n_iter,
BurnIn          = burn_in,
model           = "Multinomial",
N               = N,
lambda          = 1/(69.416 * 365),
mu              = 1/(69.416 * 365),
period_start    = phases,
opt_num         = opt_num,
auto.initialize = T,
alpha_u         = 0.5,
f               = 0.15,
plot            = plt,
save_plots      = save_plt
)
# predict -----------
result    <- SEIRfansy::SEIRfansy.predict(
data            = abs(data %>% dplyr::select(-date)),
init_pars       = NULL,
data_init       = data_initial,
T_predict       = t_pred,
niter           = n_iter,
BurnIn          = burn_in,
model           = "Multinomial",
N               = N,
lambda          = 1/(69.416 * 365),
mu              = 1/(69.416 * 365),
period_start    = phases,
opt_num         = opt_num,
auto.initialize = T,
alpha_u         = 0.5,
f               = 0.15,
plot            = plt,
save_plots      = save_plt
)
warnings()
# predict -----------
result    <- SEIRfansy::SEIRfansy.predict(
data            = abs(data %>% dplyr::select(-date)),
init_pars       = NULL,
data_init       = data_initial,
T_predict       = t_pred,
niter           = n_iter,
BurnIn          = burn_in,
model           = "Multinomial",
N               = N,
lambda          = 1/(69.416 * 365),
mu              = 1/(69.416 * 365),
period_start    = phases,
opt_num         = opt_num,
auto.initialize = T,
alpha_u         = 0.5,
f               = 0.15,
plot            = plt,
save_plots      = save_plt
)
data
data %>% pull(Confirmed)
state_name
phases
max_date   <- as.Date(today - 1)
min_date   <- as.Date(max_date - (days_of_data - 1))
tmp_dates <- seq.Date(from = as.Date(start_date),
to   = as.Date(end_date),
by    = "day")
start_date = min_date
end_date = max_date
tmp_dates <- seq.Date(from = as.Date(start_date),
to   = as.Date(end_date),
by    = "day")
tmp_dates
length(tmp_dates)
tmp_phases <- c(1,
tmp_dates %>% lubridate::day() %>% which(x = . == 1)) %>%
unique()
tmp_phases
?seq
?seq.Date
seq.Date(from = start_date, to = end_date, by = "15 days")
seq.Date(from = start_date, to = end_date, by = "-15 days")
start_date
tmp_dates
rev(tmp_dates)
rev(tmp_dates)[seq(1, length(tmp_dates), 15)]
rev(rev(tmp_dates)[seq(1, length(tmp_dates), 15)])
tmp_dates %>% which(x = rev(rev(tmp_dates)[seq(1, length(tmp_dates), 15)]))
?which
tmp_dates %>% which(x = . %in% rev(rev(tmp_dates)[seq(1, length(tmp_dates), 15)]))
c(1, tmp_dates %>% which(x = . %in% rev(rev(tmp_dates)[seq(1, length(tmp_dates), 15)])))
tmp_phases <- c(1,
tmp_dates %>% which(x = . %in% rev(rev(tmp_dates)[seq(1, length(tmp_dates), 15)]))) %>%
unique()
tmp_phases
tmp_phases[!tmp_phases %in% 2:15]
get_phase <- function(start_date = min_date, end_date = max_date, phase_length = 15) {
tmp_dates <- seq.Date(from = as.Date(start_date),
to   = as.Date(end_date),
by    = "day")
tmp_phases <- c(1,
tmp_dates %>% which(x = . %in% rev(rev(tmp_dates)[seq(1, length(tmp_dates), phase_length)]))) %>%
unique()
tmp_phases <- tmp_phases[!tmp_phases %in% 2:phase_length]
return(tmp_phases)
}
phases       <- get_phase(start_date = min_date, end_date = max_date)
phases
get_phase(start_date = min_date, end_date = max_date, phase_length = 20)
get_phase(start_date = min_date, end_date = max_date, phase_length = 25)
get_phase(start_date = min_date, end_date = max_date, phase_length = 10)
get_phase(start_date = min_date, end_date = max_date, phase_length = 8)
library(tidyverse)
readr::read_csv("https://api.covid19india.org/csv/latest/state_wise_daily.csv",
col_types = cols()) %>%
janitor::clean_names() %>%
dplyr::select("date" = "date_ymd", "status", "val" = tolower(state)) %>%
arrange(date) %>%
tidyr::pivot_wider(
names_from  = "status",
values_from = "val",
id_cols = "date"
) %>%
dplyr::filter(date <= max_date)
readr::read_csv("https://api.covid19india.org/csv/latest/state_wise_daily.csv",
col_types = cols())
state
readr::read_csv("https://api.covid19india.org/csv/latest/state_wise_daily.csv",
col_types = cols()) %>%
janitor::clean_names() %>%
dplyr::select("date" = "date_ymd", "status", "val" = tolower(state))
readr::read_csv("https://api.covid19india.org/csv/latest/state_wise_daily.csv",
col_types = cols()) %>%
janitor::clean_names() %>%
dplyr::select("date" = "date_ymd", "status", "val" = tolower(state)) %>%
arrange(date) %>%
tidyr::pivot_wider(
names_from  = "status",
values_from = "val",
id_cols = "date"
)
pred_clean <- readRDS("~/Documents/projects/covid/covind_seirfansy_take2/output/pred_clean_tt.rds")
# all plot
pred_clean %>%
dplyr::filter(section == "positive_daily_reported" & pred == 1) %>%
dplyr::select(place = state, date, daily_cases = mean, pred) %>%
bind_rows(obs) %>%
mutate(pred = as.factor(pred)) %>%
ggplot(aes(x = date, y = daily_cases)) +
geom_line(aes(group = pred, color = pred), size = 1) +
labs(
title    = glue("SEIRfansy predicted reported cases in {state_name}"),
x        = "Date",
y        = "Daily COVID-19 cases",
caption  = "**\uA9 COV-IND-19 Study Group**"
) +
scale_y_continuous(labels = scales::comma) +
scale_x_date(date_labels = c("%m/%d/%y")) +
theme_classic() +
theme(
plot.title = element_text(face = "bold"),
plot.caption = element_markdown(hjust = 0),
legend.position = "none"
)
pacman::p_load(tidyverse, arm, janitor, DescTools, patchwork, pbapply, here, glue, ggtext)
pacman::p_load_gh("umich-biostatistics/SEIRfansy", "maxsal/covid19india")
# all plot
pred_clean %>%
dplyr::filter(section == "positive_daily_reported" & pred == 1) %>%
dplyr::select(place = state, date, daily_cases = mean, pred) %>%
bind_rows(obs) %>%
mutate(pred = as.factor(pred)) %>%
ggplot(aes(x = date, y = daily_cases)) +
geom_line(aes(group = pred, color = pred), size = 1) +
labs(
title    = glue("SEIRfansy predicted reported cases in {state_name}"),
x        = "Date",
y        = "Daily COVID-19 cases",
caption  = "**\uA9 COV-IND-19 Study Group**"
) +
scale_y_continuous(labels = scales::comma) +
scale_x_date(date_labels = c("%m/%d/%y")) +
theme_classic() +
theme(
plot.title = element_text(face = "bold"),
plot.caption = element_markdown(hjust = 0),
legend.position = "none"
)
# preview prediction plots -----------
obs <- bind_rows(get_nat_counts(), get_state_counts()) %>%
dplyr::select(place, date, daily_cases) %>%
dplyr::filter(place == state_name) %>%
dplyr::mutate(pred = 0)
# params ----------
production   <- FALSE
state        <- "jh" # use `tt` for India
days_of_data <- 100
state        <- "tt" # use `tt` for India
days_of_data <- 100
# setup -----------
today      <- as.Date("2021-07-13")
`%notin%`  <- Negate(`%in%`)
f          <- list.files(here("src"))
for (i in seq_along(f)) source(here("src", glue("{f[i]}")))
# Set variables based on testing or production
if (production == TRUE) {
n_iter    <- 1e5
burn_in   <- 1e5
opt_num   <- 200
} else {
n_iter    <- 1e3 #default 1e5
burn_in   <- 1e2 #default 1e5
opt_num   <- 1   #default 200
}
# specs -----------
state_name <- pop %>% dplyr::filter(abbrev == state) %>% pull(place)
max_date   <- as.Date(today - 1)
min_date   <- as.Date(max_date - (days_of_data - 1))
obs_days   <- length(as.Date(min_date):as.Date(max_date))
t_pred     <- 150 # number of predicted days
N          <- pop %>% filter(abbrev == state) %>% pull(population)
plt        <- FALSE
save_plt   <- FALSE
# all plot
pred_clean %>%
dplyr::filter(section == "positive_daily_reported" & pred == 1) %>%
dplyr::select(place = state, date, daily_cases = mean, pred) %>%
bind_rows(obs) %>%
mutate(pred = as.factor(pred)) %>%
ggplot(aes(x = date, y = daily_cases)) +
geom_line(aes(group = pred, color = pred), size = 1) +
labs(
title    = glue("SEIRfansy predicted reported cases in {state_name}"),
x        = "Date",
y        = "Daily COVID-19 cases",
caption  = "**\uA9 COV-IND-19 Study Group**"
) +
scale_y_continuous(labels = scales::comma) +
scale_x_date(date_labels = c("%m/%d/%y")) +
theme_classic() +
theme(
plot.title = element_text(face = "bold"),
plot.caption = element_markdown(hjust = 0),
legend.position = "none"
)
# preview prediction plots -----------
obs <- bind_rows(get_nat_counts(), get_state_counts()) %>%
dplyr::select(place, date, daily_cases) %>%
dplyr::filter(place == state_name) %>%
dplyr::mutate(pred = 0)
# all plot
pred_clean %>%
dplyr::filter(section == "positive_daily_reported" & pred == 1) %>%
dplyr::select(place = state, date, daily_cases = mean, pred) %>%
bind_rows(obs) %>%
mutate(pred = as.factor(pred)) %>%
ggplot(aes(x = date, y = daily_cases)) +
geom_line(aes(group = pred, color = pred), size = 1) +
labs(
title    = glue("SEIRfansy predicted reported cases in {state_name}"),
x        = "Date",
y        = "Daily COVID-19 cases",
caption  = "**\uA9 COV-IND-19 Study Group**"
) +
scale_y_continuous(labels = scales::comma) +
scale_x_date(date_labels = c("%m/%d/%y")) +
theme_classic() +
theme(
plot.title = element_text(face = "bold"),
plot.caption = element_markdown(hjust = 0),
legend.position = "none"
)
# libraries ------------
if (nzchar(system.file(package = "pacman"))) install.packages("pacman")
# libraries ------------
if (!nzchar(system.file(package = "pacman"))) install.packages("pacman")
pacman::p_load(tidyverse, arm, janitor, DescTools, patchwork, pbapply, here, glue, ggtext)
install.packages("DescTools")
pacman::p_load(tidyverse, arm, janitor, DescTools, patchwork, pbapply, here, glue, ggtext)
pacman::p_load_gh("umich-biostatistics/SEIRfansy", "maxsal/covid19india")
library(SEIRfansy)
# libraries ------------
if (!nzchar(system.file(package = "pacman"))) install.packages("pacman")
pacman::p_load(tidyverse, arm, janitor, DescTools, patchwork, pbapply, here, glue, ggtext)
pacman::p_load_gh("umich-biostatistics/SEIRfansy", "maxsal/covid19india")
# params ----------
production   <- FALSE
state        <- "tt" # use `tt` for India
days_of_data <- 100
# setup -----------
today      <- as.Date("2021-07-13")
`%notin%`  <- Negate(`%in%`)
f          <- list.files(here("src"))
for (i in seq_along(f)) source(here("src", glue("{f[i]}")))
# Set variables based on testing or production
if (production == TRUE) {
n_iter    <- 1e5
burn_in   <- 1e5
opt_num   <- 200
} else {
n_iter    <- 1e3 #default 1e5
burn_in   <- 1e2 #default 1e5
opt_num   <- 1   #default 200
}
# specs -----------
state_name <- pop %>% dplyr::filter(abbrev == state) %>% pull(place)
max_date   <- as.Date(today - 1)
min_date   <- as.Date(max_date - (days_of_data - 1))
obs_days   <- length(as.Date(min_date):as.Date(max_date))
t_pred     <- 150 # number of predicted days
N          <- pop %>% filter(abbrev == state) %>% pull(population)
plt        <- FALSE
save_plt   <- FALSE
# load and prepare ----------
data <- readr::read_csv("https://api.covid19india.org/csv/latest/state_wise_daily.csv",
col_types = cols()) %>%
janitor::clean_names() %>%
dplyr::select("date" = "date_ymd", "status", "val" = tolower(state)) %>%
arrange(date) %>%
tidyr::pivot_wider(
names_from  = "status",
values_from = "val",
id_cols = "date"
) %>%
dplyr::filter(date <= max_date)
data_initial <- get_init(data)
data         <- data %>% dplyr::filter(date >= min_date)
mCFR         <- tail(cumsum(data$Deceased) / cumsum(data$Deceased + data$Recovered), 1)
phases       <- get_phase(start_date = min_date, end_date = max_date)
# predict -----------
result    <- SEIRfansy::SEIRfansy.predict(
data            = abs(data %>% dplyr::select(-date)),
init_pars       = NULL,
data_init       = data_initial,
T_predict       = t_pred,
niter           = n_iter,
BurnIn          = burn_in,
model           = "Multinomial",
N               = N,
lambda          = 1/(69.416 * 365),
mu              = 1/(69.416 * 365),
period_start    = phases,
opt_num         = opt_num,
auto.initialize = T,
alpha_u         = 0.5,
f               = 0.15,
plot            = plt,
save_plots      = save_plt
)
pred_clean <- clean_prediction(result$prediction,
state    = state_name,
obs_days = obs_days,
t_pred   = t_pred)
# preview prediction plots -----------
obs <- bind_rows(get_nat_counts(), get_state_counts()) %>%
dplyr::select(place, date, daily_cases) %>%
dplyr::filter(place == state_name) %>%
dplyr::mutate(pred = 0)
# all plot
pred_clean %>%
dplyr::filter(section == "positive_daily_reported" & pred == 1) %>%
dplyr::select(place = state, date, daily_cases = mean, pred) %>%
bind_rows(obs) %>%
mutate(pred = as.factor(pred)) %>%
ggplot(aes(x = date, y = daily_cases)) +
geom_line(aes(group = pred, color = pred), size = 1) +
labs(
title    = glue("SEIRfansy predicted reported cases in {state_name}"),
x        = "Date",
y        = "Daily COVID-19 cases",
caption  = "**\uA9 COV-IND-19 Study Group**"
) +
scale_y_continuous(labels = scales::comma) +
scale_x_date(date_labels = c("%m/%d/%y")) +
theme_classic() +
theme(
plot.title = element_text(face = "bold"),
plot.caption = element_markdown(hjust = 0),
legend.position = "none"
)
phases
# restricted plot
pred_clean %>%
dplyr::filter(section == "positive_daily_reported" & pred == 1) %>%
dplyr::select(place = state, date, daily_cases = mean, pred) %>%
bind_rows(obs) %>%
dplyr::mutate(pred = as.factor(pred)) %>%
dplyr::filter(date >= "2021-01-01" & date <= "2021-10-01") %>%
ggplot(aes(x = date, y = daily_cases)) +
geom_line(aes(group = pred, color = pred), size = 1) +
labs(
title    = glue("SEIRfansy predicted reported cases in {state_name}"),
x        = "Date",
y        = "Daily COVID-19 cases",
caption  = "**\uA9 COV-IND-19 Study Group**"
) +
scale_y_continuous(labels = scales::comma) +
scale_x_date(date_labels = c("%m/%d/%y")) +
theme_classic() +
theme(
plot.title = element_text(face = "bold"),
plot.caption = element_markdown(hjust = 0),
legend.position = "none"
)
min_date   <- as.Date(max_date - (days_of_data - 1))
min_date
max_date
# libraries ------------
if (!nzchar(system.file(package = "pacman"))) install.packages("pacman")
pacman::p_load(tidyverse, arm, janitor, DescTools, patchwork, pbapply, here, glue, ggtext)
pacman::p_load_gh("umich-biostatistics/SEIRfansy", "maxsal/covid19india")
# params ----------
production   <- TRUE
state        <- "tt" # use `tt` for India
days_of_data <- 100
# setup -----------
today      <- Sys.Date() - 1
`%notin%`  <- Negate(`%in%`)
f          <- list.files(here("src"))
for (i in seq_along(f)) source(here("src", glue("{f[i]}")))
# Set variables based on testing or production
if (production == TRUE) {
n_iter    <- 1e5
burn_in   <- 1e5
opt_num   <- 200
} else {
n_iter    <- 1e3 #default 1e5
burn_in   <- 1e2 #default 1e5
opt_num   <- 1   #default 200
}
# specs -----------
state_name <- pop %>% dplyr::filter(abbrev == state) %>% pull(place)
max_date   <- as.Date(today - 1)
min_date   <- as.Date(max_date - (days_of_data - 1))
obs_days   <- length(as.Date(min_date):as.Date(max_date))
t_pred     <- 150 # number of predicted days
N          <- pop %>% filter(abbrev == state) %>% pull(population)
plt        <- FALSE
save_plt   <- FALSE
max_date
max_date - (days_of_data - 1)
class(max_date - (days_of_data - 1))
